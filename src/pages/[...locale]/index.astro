---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntry, render } from "astro:content";
import OffsetCircleGrid from "../../components/OffsetCircleGrid.astro";
import Flavor from "../../components/Flavor.astro";
import NewsGrid from "../../components/NewsGrid.astro";
import Link from "../../components/Link.astro";
import { Icon } from "astro-icon/components";
import {
	getLocalizedStaticPaths,
	localizedContentPath,
} from "../../i18n/utils";

export const getStaticPaths = getLocalizedStaticPaths;

const page = await getEntry("pages", localizedContentPath(Astro.url, "index"));

const flavorsSection = await getEntry(
	"sections",
	localizedContentPath(Astro.url, "index/sections/flavors"),
);
const { Content: FlavorsContent } = await render(flavorsSection!);

const newFlavors = await getCollection("flavors", ({ data }) => data.new);

const news = (
	await getCollection("news", ({ data }) => data.pubDate <= new Date())
)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3);

const newSection = await getEntry(
	"sections",
	localizedContentPath(Astro.url, "index/sections/news"),
);
const { Content: NewsContent } = await render(newSection!);
---

<style>
	section {
		p {
			margin-bottom: var(--space-lg);
		}

		> a {
			margin-top: var(--space-lg);
		}
	}
</style>

<BaseLayout pageTitle={page?.data.title!}>
	{
		newFlavors.length && (
			<section slot="sections">
				<h2>{flavorsSection?.data.heading}</h2>
				<FlavorsContent />

				<OffsetCircleGrid>
					{newFlavors.map(({ data }) => (
						<Flavor flavor={data} />
					))}
				</OffsetCircleGrid>

				<Link href="/assortment" class="button">
					{flavorsSection?.data.action}{" "}
					<Icon name="tabler:chevron-right" />
				</Link>
			</section>
		)
	}
	<section slot="sections">
		<h2>{newSection?.data.heading}</h2>

		<NewsContent />

		<NewsGrid news={news} />

		<Link class="button" href="/news"
			>{newSection?.data.action}
			<Icon name="tabler:chevron-right" /></Link
		>
	</section>
</BaseLayout>
